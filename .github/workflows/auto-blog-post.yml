name: Auto Generate Blog Post

on:
  schedule:
    # Runs at midnight UTC on the 1st and 15th of every month (every 2 weeks)
    - cron: '0 0 1,15 * *'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for git log analysis

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Configure git
        run: |
          git config --global user.name "Blog Agent Bot"
          git config --global user.email "bot@geoffsee.dev"

      - name: Generate blog post
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          bun blog-agent.ts

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add posts/*.md assets/images/*.png
          git commit -m "Auto-generate blog post from recent git activity

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Blog Agent <bot@geoffsee.dev>"
          git push

      - name: No changes detected
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "No new blog post generated - no recent git activity or post already exists"